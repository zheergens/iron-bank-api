{% extends "layouts/base.html" %}

{% block head_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css', v='1.0.3') }}">
<style>
/* 在此处移除任何冲突的内联样式 */
</style>
{% endblock %}

{% block body %}
<div class="admin-layout">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">{% if current_user.is_admin %}管理系统{% else %}用户中心{% endif %}</div>
        </div>
        <div class="sidebar-menu">
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin.index') }}" class="menu-item {% if request.endpoint == 'admin.index' %}active{% endif %}">
                <i class="fas fa-tachometer-alt"></i>
                <span>仪表盘</span>
            </a>
            {% endif %}
            <a href="{{ url_for('user.profile') }}" class="menu-item {% if request.endpoint == 'user.profile' %}active{% endif %}">
                <i class="fas fa-user"></i>
                <span>个人中心</span>
            </a>
            {% if current_user.is_admin %}
            <a href="{{ url_for('admin.users') }}" class="menu-item {% if request.endpoint == 'admin.users' %}active{% endif %}">
                <i class="fas fa-users"></i>
                <span>用户管理</span>
            </a>
            <a href="{{ url_for('admin.system_info') }}" class="menu-item {% if request.endpoint == 'admin.system_info' %}active{% endif %}">
                <i class="fas fa-cog"></i>
                <span>系统信息</span>
            </a>
            {% endif %}
        </div>
    </div>
    
    <div class="admin-content" id="adminContent">
        <div class="admin-header" id="adminHeader">
            <div class="header-left">
                <div class="breadcrumb">
                    <i class="fas fa-home"></i>
                    <span>首页</span>
                    {% if request.endpoint != 'admin.index' %}
                    <i class="fas fa-chevron-right"></i>
                    <span>{{ self.title() }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="header-right">
                <div class="user-avatar">
                    <div class="avatar-img">
                        <div class="user-initial">{{ current_user.username[0].upper() }}</div>
                    </div>
                </div>
                <div class="user-menu" id="userMenu">
                    <div class="user-menu-items">
                        <a href="{{ url_for('user.profile') }}" class="user-menu-item">
                            <i class="fas fa-user"></i>
                            <span>个人信息</span>
                        </a>
                        <a href="{{ url_for('user.change_password') }}" class="user-menu-item">
                            <i class="fas fa-key"></i>
                            <span>修改密码</span>
                        </a>
                        <form id="logoutForm" action="{{ url_for('auth.logout') }}" method="post" style="margin: 0; padding: 0;">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="user-menu-item" style="width: 100%; text-align: left; background: none; border: none; cursor: pointer; padding: 8px 16px;">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>退出登录</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% block admin_content %}{% endblock %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const adminContent = document.getElementById('adminContent');
    const adminHeader = document.getElementById('adminHeader');
    let isSidebarCollapsed = false;

    // 检查本地存储中的侧边栏状态
    const storedState = localStorage.getItem('sidebarCollapsed');
    if (storedState === 'true') {
        sidebar.classList.add('collapsed');
        adminContent.classList.add('expanded');
        adminHeader.classList.add('expanded');
        isSidebarCollapsed = true;
    }

    // 双击侧边栏切换状态
    sidebar.addEventListener('dblclick', function(e) {
        isSidebarCollapsed = !isSidebarCollapsed;
        sidebar.classList.toggle('collapsed');
        adminContent.classList.toggle('expanded');
        adminHeader.classList.toggle('expanded');
        localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
    });
    
    // 初始化用户菜单交互
    setupUserMenu();
});

function setupUserMenu() {
    const userAvatar = document.querySelector('.user-avatar');
    const userMenu = document.getElementById('userMenu');
    
    if (userAvatar && userMenu) {
        // 点击头像显示/隐藏菜单
        userAvatar.addEventListener('click', function(e) {
            e.stopPropagation(); // 阻止事件冒泡
            userMenu.classList.toggle('show');
        });
        
        // 菜单内的点击不应该关闭菜单，但允许表单提交
        userMenu.addEventListener('click', function(e) {
            // 检查是否点击的是退出按钮或其内部元素
            if (!e.target.closest('button[type="submit"]')) {
                e.stopPropagation();
            }
        });
        
        // 点击其他区域关闭菜单
        document.addEventListener('click', function(e) {
            if (userMenu.classList.contains('show')) {
                userMenu.classList.remove('show');
            }
        });
    }
}
</script>
{% endblock %} 