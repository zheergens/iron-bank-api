{% extends "layouts/admin.html" %}

{% block title %}用户管理{% endblock %}

{% block head_css %}
{{ super() }}
<style>
.content-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    padding: 24px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
}

.header h1 {
    font-size: 20px;
    color: #1f2937;
    margin: 0;
    font-weight: 500;
}

.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
}

.data-table th {
    background: #fafafa;
    padding: 12px;
    text-align: left;
    font-weight: 500;
    color: #595959;
    border-bottom: 1px solid #f0f0f0;
    font-size: 13px;
}

.data-table td {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    color: #262626;
    font-size: 13px;
    transition: background 0.2s;
}

.data-table tr:hover td {
    background: #fafafa;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: 0 8px;
    height: 22px;
    border-radius: 11px;
    font-size: 12px;
    font-weight: normal;
    line-height: 20px;
    box-sizing: border-box;
    border: 1px solid transparent;
}

.badge-primary {
    background: #e6f7ff;
    border-color: #91d5ff;
    color: #1890ff;
}

.badge-default {
    background: #f5f5f5;
    border-color: #d9d9d9;
    color: #595959;
}

.action-buttons {
    display: flex;
    gap: 8px;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}

.btn-primary {
    background: #1890ff;
    color: white;
}

.btn-primary:hover {
    background: #40a9ff;
}

.action-btn {
    width: 32px;
    height: 32px;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    background: transparent;
}

.action-btn svg {
    width: 16px;
    height: 16px;
    transition: all 0.2s;
}

.action-btn.edit {
    color: #595959;
}

.action-btn.edit:hover {
    color: #1890ff;
    background: #e6f7ff;
    border-color: #91d5ff;
}

.action-btn.delete {
    color: #595959;
}

.action-btn.delete:hover {
    color: #ff4d4f;
    background: #fff1f0;
    border-color: #ffa39e;
}

.icon-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
}
</style>
{% endblock %}

{% block admin_content %}
<div class="content-card">
    <div class="header">
        <h1>用户管理</h1>
        <button class="btn btn-primary" onclick="showAddUserModal()">
            <i class="fas fa-plus"></i>
            添加用户
        </button>
    </div>

    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>用户名</th>
                    <th>邮箱</th>
                    <th>手机号</th>
                    <th>角色</th>
                    <th>状态</th>
                    <th>最后登录</th>
                    <th style="width: 100px;">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.phone or '未设置' }}</td>
                    <td>
                        <span class="badge badge-{{ 'primary' if user.is_admin else 'default' }}">
                            {{ 'admin' if user.is_admin else 'user' }}
                        </span>
                    </td>
                    <td>
                        <span class="badge badge-{{ 'success' if user.is_active else 'danger' }}">
                            {{ '活跃' if user.is_active else '被禁用' }}
                        </span>
                    </td>
                    <td>{{ user.last_login.strftime('%Y-%m-%d %H:%M:%S') if user.last_login else '从未登录' }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="showEditUserModal('{{ user._id }}', '{{ user.username }}', '{{ user.email }}', '{{ user.phone or '' }}')">
                                <div class="icon-wrapper">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </div>
                            </button>
                            {% if not user.is_admin %}
                            <button class="action-btn delete" onclick="confirmDeleteUser('{{ user._id }}', '{{ user.username }}')">
                                <div class="icon-wrapper">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18"></path>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"></path>
                                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </div>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 添加用户模态框 -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>添加用户</h2>
            <button class="close-button" onclick="closeAddUserModal()">&times;</button>
        </div>
        <form id="addUserForm" method="post" action="{{ url_for('admin.new_user') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="modal-body">
                <div class="form-group">
                    <label for="username">用户名</label>
                    <input type="text" id="username" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="email">邮箱</label>
                    <input type="email" id="email" name="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="phone">手机号</label>
                    <input type="text" id="phone" name="phone" class="form-input">
                </div>
                <div class="form-group">
                    <label for="role">角色</label>
                    <select id="role" name="role" class="form-input">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <p class="text-muted">注意：用户的初始密码将设置为：用户名 + 123</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">取消</button>
                <button type="submit" class="btn btn-primary">确认添加</button>
            </div>
        </form>
    </div>
</div>

<!-- 编辑用户模态框 -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>编辑用户</h2>
            <button class="close-button" onclick="closeEditUserModal()">&times;</button>
        </div>
        <form id="editUserForm" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="modal-body">
                <input type="hidden" id="editUserId" name="user_id">
                <div class="form-group">
                    <label for="editUsername">用户名</label>
                    <input type="text" id="editUsername" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="editEmail">邮箱</label>
                    <input type="email" id="editEmail" name="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="editPhone">手机号</label>
                    <input type="text" id="editPhone" name="phone" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">取消</button>
                <button type="submit" class="btn btn-primary">保存</button>
            </div>
        </form>
    </div>
</div>

<!-- 删除确认对话框 -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>确认删除</h2>
            <button class="close-button" onclick="closeDeleteConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p>确定要删除用户 <span id="deleteUserName"></span> 吗？</p>
            <p class="text-warning">注意：此操作将禁用该用户，用户将无法登录系统。</p>
        </div>
        <div class="modal-footer">
            <form id="deleteUserForm" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()">取消</button>
                <button type="submit" class="btn btn-danger">确认删除</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
// 添加用户相关函数
function showAddUserModal() {
    document.getElementById('addUserModal').style.display = 'block';
}

function closeAddUserModal() {
    document.getElementById('addUserModal').style.display = 'none';
}

// 编辑用户相关函数
function showEditUserModal(userId, username, email, phone) {
    document.getElementById('editUserId').value = userId;
    document.getElementById('editUsername').value = username;
    document.getElementById('editEmail').value = email;
    document.getElementById('editPhone').value = phone;
    
    const form = document.getElementById('editUserForm');
    form.action = `/admin/users/${userId}/edit`;
    
    document.getElementById('editUserModal').style.display = 'block';
}

function closeEditUserModal() {
    document.getElementById('editUserModal').style.display = 'none';
}

// 删除用户相关函数
function confirmDeleteUser(userId, username) {
    document.getElementById('deleteUserName').textContent = username;
    const form = document.getElementById('deleteUserForm');
    form.action = `/admin/users/delete/${userId}`;
    document.getElementById('deleteConfirmModal').style.display = 'block';
}

function closeDeleteConfirmModal() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
}

// 关闭模态框的通用函数
window.onclick = function(event) {
    const addModal = document.getElementById('addUserModal');
    const editModal = document.getElementById('editUserModal');
    const deleteModal = document.getElementById('deleteConfirmModal');
    
    if (event.target == addModal) {
        addModal.style.display = 'none';
    }
    if (event.target == editModal) {
        editModal.style.display = 'none';
    }
    if (event.target == deleteModal) {
        deleteModal.style.display = 'none';
    }
}
</script>

<style>
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 4px;
    color: white;
    z-index: 1000;
    animation: slideIn 0.3s ease-in-out;
}

.toast.success {
    background-color: #4CAF50;
}

.toast.error {
    background-color: #f44336;
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %} 