{% extends "base.html" %}

{% block head_css %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css', v='1.0.1') }}">
<style>
.admin-header {
    background: #fff;
    height: 64px;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    position: fixed;
    top: 0;
    right: 0;
    left: 240px;
    z-index: 1000;
    transition: left 0.3s;
}

.admin-header.expanded {
    left: 80px;
}

.admin-content {
    padding: 88px 24px 24px;
    min-height: 100vh;
    background: #f3f4f6;
    margin-left: 240px;
    transition: margin-left 0.3s;
}

.admin-content.expanded {
    margin-left: 80px;
}

.content-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    padding: 24px;
}

.header-left {
    display: flex;
    align-items: center;
    gap: 16px;
}

.breadcrumb {
    color: #6b7280;
    font-size: 14px;
}

.header-right {
    display: flex;
    align-items: center;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 20px;
    background: #3b82f6;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    cursor: pointer;
}

.user-menu {
    position: absolute;
    top: 100%;
    right: 24px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    width: 140px;
    display: none;
    z-index: 1000;
    margin-top: 8px;
}

.user-menu.show {
    display: block;
}

.user-menu-items {
    padding: 8px 0;
}

.user-menu-item {
    padding: 8px 16px;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #374151;
    text-decoration: none;
    cursor: pointer;
}

.user-menu-item:hover {
    background: #f3f4f6;
}

.user-menu-item i {
    width: 16px;
    text-align: center;
    color: #6b7280;
}
</style>
{% endblock %}

{% block page_content %}
<div class="admin-layout">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">管理系统</div>
        </div>
        <div class="sidebar-menu">
            <a href="{{ url_for('admin.index') }}" class="menu-item {% if request.endpoint == 'admin.index' %}active{% endif %}">
                <i class="fas fa-tachometer-alt"></i>
                <span>仪表盘</span>
            </a>
            <a href="{{ url_for('user.profile') }}" class="menu-item {% if request.endpoint == 'user.profile' %}active{% endif %}">
                <i class="fas fa-user"></i>
                <span>个人中心</span>
            </a>
            <a href="{{ url_for('admin.users') }}" class="menu-item {% if request.endpoint == 'admin.users' %}active{% endif %}">
                <i class="fas fa-users"></i>
                <span>用户管理</span>
            </a>
            <a href="{{ url_for('admin.system_info') }}" class="menu-item {% if request.endpoint == 'admin.system_info' %}active{% endif %}">
                <i class="fas fa-cog"></i>
                <span>系统信息</span>
            </a>
        </div>
    </div>
    
    <div class="admin-content" id="adminContent">
        <div class="admin-header" id="adminHeader">
            <div class="header-left">
                <div class="breadcrumb">
                    <i class="fas fa-home"></i>
                    <span>首页</span>
                    {% if request.endpoint != 'admin.index' %}
                    <i class="fas fa-chevron-right"></i>
                    <span>{{ self.title() }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="header-right">
                <div class="user-avatar" onclick="toggleUserMenu()">
                    {{ current_user.username[0].upper() }}
                </div>
                <div class="user-menu" id="userMenu">
                    <div class="user-menu-items">
                        <div class="user-menu-item" onclick="document.getElementById('logoutForm').submit()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
                <form id="logoutForm" action="{{ url_for('auth.logout') }}" method="post" style="display: none;"></form>
            </div>
        </div>
        {% block admin_content %}{% endblock %}
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sidebar = document.getElementById('sidebar');
    const adminContent = document.getElementById('adminContent');
    const adminHeader = document.getElementById('adminHeader');
    let isSidebarCollapsed = false;

    // 检查本地存储中的侧边栏状态
    const storedState = localStorage.getItem('sidebarCollapsed');
    if (storedState === 'true') {
        sidebar.classList.add('collapsed');
        adminContent.classList.add('expanded');
        adminHeader.classList.add('expanded');
        isSidebarCollapsed = true;
    }

    // 双击侧边栏切换状态
    sidebar.addEventListener('dblclick', function(e) {
        isSidebarCollapsed = !isSidebarCollapsed;
        sidebar.classList.toggle('collapsed');
        adminContent.classList.toggle('expanded');
        adminHeader.classList.toggle('expanded');
        localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
    });

    // 为移动设备添加触摸手势
    let touchStartX = 0;
    let touchEndX = 0;

    sidebar.addEventListener('touchstart', function(e) {
        touchStartX = e.touches[0].clientX;
    });

    sidebar.addEventListener('touchend', function(e) {
        touchEndX = e.changedTouches[0].clientX;
        handleSwipe();
    });

    function handleSwipe() {
        const swipeDistance = touchEndX - touchStartX;
        if (Math.abs(swipeDistance) > 50) { // 最小滑动距离
            if (swipeDistance < 0 && !isSidebarCollapsed) { // 向左滑动
                isSidebarCollapsed = true;
                sidebar.classList.add('collapsed');
                adminContent.classList.add('expanded');
                adminHeader.classList.add('expanded');
            } else if (swipeDistance > 0 && isSidebarCollapsed) { // 向右滑动
                isSidebarCollapsed = false;
                sidebar.classList.remove('collapsed');
                adminContent.classList.remove('expanded');
                adminHeader.classList.remove('expanded');
            }
            localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
        }
    }
});

function toggleUserMenu() {
    const userMenu = document.getElementById('userMenu');
    userMenu.classList.toggle('show');

    // 点击其他地方关闭菜单
    document.addEventListener('click', function closeMenu(e) {
        if (!e.target.closest('.user-avatar') && !e.target.closest('.user-menu')) {
            userMenu.classList.remove('show');
            document.removeEventListener('click', closeMenu);
        }
    });
}
</script>
{% endblock %} 