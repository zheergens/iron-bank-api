{% extends "admin/base_admin.html" %}

{% block title %}平台授权 - 登录系统{% endblock %}

{% block content %}
<div class="header">
    <h1>平台授权</h1>
</div>

<div class="dashboard-card">
    <h2 class="dashboard-title">待处理申请</h2>
    <table>
        <thead>
            <tr>
                <th>申请时间</th>
                <th>用户</th>
                <th>平台</th>
                <th>申请原因</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for request in pending_requests %}
            <tr>
                <td>{{ request.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ request.user.username }}</td>
                <td>{{ request.app.name }}</td>
                <td>{{ request.reason }}</td>
                <td>
                    <button class="btn btn-primary" onclick="approveRequest('{{ request.id }}')">批准</button>
                    <button class="btn btn-danger" onclick="rejectRequest('{{ request.id }}')">拒绝</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="dashboard-card">
    <h2 class="dashboard-title">历史记录</h2>
    <table>
        <thead>
            <tr>
                <th>处理时间</th>
                <th>用户</th>
                <th>平台</th>
                <th>状态</th>
                <th>处理人</th>
                <th>备注</th>
            </tr>
        </thead>
        <tbody>
            {% for record in history_records %}
            <tr>
                <td>{{ record.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ record.user.username }}</td>
                <td>{{ record.app.name }}</td>
                <td>
                    <span class="status-badge {% if record.status == 'approved' %}status-active{% elif record.status == 'rejected' %}status-rejected{% else %}status-pending{% endif %}">
                        {{ {"approved": "已批准", "rejected": "已拒绝", "pending": "待处理"}[record.status] }}
                    </span>
                </td>
                <td>{{ record.handler.username if record.handler else "-" }}</td>
                <td>{{ record.comment or "-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
function approveRequest(requestId) {
    if (confirm('确定要批准此申请吗？')) {
        window.location.href = "{{ url_for('admin.approve_request', request_id='') }}" + requestId;
    }
}

function rejectRequest(requestId) {
    const comment = prompt('请输入拒绝原因：');
    if (comment !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('admin.reject_request', request_id='') }}" + requestId;
        
        const commentInput = document.createElement('input');
        commentInput.type = 'hidden';
        commentInput.name = 'comment';
        commentInput.value = comment;
        
        form.appendChild(commentInput);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %} 